{% extends "adminplus/base.html" %}
{% load assets %}

{% block extrahead %}
  {{ block.super }}
  <script src="{{ STATIC_URL }}js/lib/jquery-1.11.0.min.js" type="text/javascript"></script>
  <script src="{{ STATIC_URL }}js/lib/underscore-min.js" type="text/javascript"></script>
  <script src="{{ STATIC_URL }}js/lib/backbone-min.js" type="text/javascript"></script>
  {% assets "js_all" %}
    <script type="text/javascript" src="{{ ASSET_URL }}"></script>
  {% endassets %}
  <style>
    ul.tag-list {
      margin: 0;
      padding: 0;
    }
    .tag-list li {
      width: 150px;
      list-style: none;
      display: inline-block;
    }
  .title {
    font-weight: bold;
    font-size: 18px;
  }
  </style>
{% endblock %}

{% block breadcrumbs %}
  <div class="breadcrumbs">
    <a href="{% url 'admin:index' %}">Home</a> &rsaquo;
    <a href="{% url 'admin:app_groupmanagement_changelist' %}">Groups</a> &rsaquo;
    Group email
  </div>
{% endblock %}

{% block content %}
  <div id="group-email-sender" class="module">
    <div class="title">Group email to: {{ group.name }}</div>
    <div class="title">Count users: {{ group.user_set.count }}</div>
    <form>
      {% csrf_token %}
      <div><label for="template_name">Message</label></div>
      <label>Template Keys:</label>
      <ul class="tag-list">
        <li>##FULL_NAME##</li>
        <li>##FIRST_NAME##</li>
        <li>##LAST_NAME##</li>
        <br>
        <li>##POST_ID=<i>postid</i>##</li>
        <li>##NOTIFICATION_PREFERENCES##</li>
      </ul>
      <div><textarea id="email_context" name="email_context" style="width: 635px; height: 240px;">
Dear ##FIRST_NAME##,

&lt;-- Insert Group Email Body --&gt;

The Movements.Org Team

Movements are made up of individuals. Movements.Org brings them together.

##NOTIFICATION_PREFERENCES##
      </textarea></div>
      <div><input type="text" id="email_to" name="email_to" value="{{ request.user.email }}"/>&nbsp;&nbsp;
        <button id="send-test">SEND TEST EMAIL</button>&nbsp;&nbsp;
        <button id="send-group">SEND GROUP EMAIL</button>
      </div>
      <br>
      <div class="title">Result:</div>
      <div id="result"></div>
    </form>
  </div>
  <script type="text/javascript">
    (function () {
      var TestomaticView = Backbone.View.extend({
        emailTestUrl: '{% url 'admin:group_email_test' group.pk %}',
        emailGroupUrl: '{% url 'admin:group_email_send' group.pk %}',
        events: {
          'click #send-test': 'sendTestEmail',
          'click #send-group': 'sendGroupEmail'
        },
        sendTestEmail: function(ev){
          ev.preventDefault();
          var data = {
            'message': this.$el.find('#email_context').val(),
            'email_to': this.$el.find('#email_to').val()
          };
          this.sendEmail(this.emailTestUrl, data)
        },
        sendGroupEmail: function(ev){
          ev.preventDefault();
          var data = {
            'message': this.$el.find('#email_context').val()
          };
          this.sendEmail(this.emailGroupUrl, data)
        },
        sendEmail: function(url, data){
          $.ajax({
            url: url,
            type: 'post',
            dataType: 'json',
            context: this,
            data: data,
            success: function(data) {
              this.$el.find('#result').html(data.message + ' at ' + new Date());
            },
            error: function() {
              this.$el.find('#result').html('Problem');
            }
          });
        }
      });
      new TestomaticView({el: '#group-email-sender'});
    })();
  </script>
{% endblock content %}