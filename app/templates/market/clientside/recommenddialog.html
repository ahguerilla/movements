{% load i18n %}
<div id="recommenddialog" class="modal fade movements-form">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
        <h4 class="modal-title">{%trans "Recommend this"%}<span id="rec-thing"></span></h4>
        <div id="recerror"></div>
      </div>
      <div class="modal-body">
        <label for="touser">{%trans "To: username or email address"%}</label>
        <div style="margin-bottom:5px;">
          <input  class="form-control" id="touser" type="text" name="subject" required="true" placeholder="{%trans "Start typing a username or enter an email address"%}"/>
        </div>

        <label for="recsub">{%trans "Subject"%}</label>
        <div style="margin-bottom:5px;">
          <input  class="form-control" id="recsub" type="text" name="subject" required="true"/>
        </div>
        <label for="recmessage">{%trans "Message"%}</label>
        <div>
          <textarea class="form-control" name="recmessage" id="recmessage" rows="4" placeholder="" required="true"></textarea>
        </div>
        <div class="modal-footer">
          <div class="row action-text">
            <div class="col-sm-offset-2 col-sm-2 form-main-button">
              <a href="#" class="action-link cancelrec" data-dismiss="modal">{% trans 'Cancel' %}</a>
            </div>
            <div class="col-sm-6 form-main-button">
              <button type="button" class="btn btn-action full-width send sendrec">{% trans 'Send' %}</button>
            </div>
          </div>
        </div>
      </div>
    </div><!-- /.modal-content -->
  </div><!-- /.modal-dialog -->
</div><!-- /.modal -->

<script type="text/javascript" id="recommend_view">
 (function () {
   var RecommendDialog = window.ahr.BaseView.extend({
     el: 'body',
     events: {
       'click .sendrec': 'send',
       'click .recommend': 'show'
     },

     show: function(ev){
      var subject = ev.currentTarget.getAttribute('subject'),
        message = ev.currentTarget.getAttribute('message'),
        obj_id = ev.currentTarget.getAttribute('obj_id'),
        rec_type = ev.currentTarget.getAttribute('rec_type');
      this.setup(rec_type, obj_id, subject, message);
      this.clearalert('#recerror');
     },

     setHeader: function(rec_type){
      var dialog_header;
      if(rec_type === "user"){
        dialog_header = ' {%trans "user"%}';
      }else{
        dialog_header = ' {%trans "post"%}';
      }
      $('#rec-thing').text(dialog_header);
     },

     setup: function (rec_type, obj_id, subject, message) {
       $('#touser').typeahead({
         remote: window.ahr.app_urls['getusernames'] + '?username=%QUERY'
       });
       $('.sendrec').prop('disabled', false);
       this.rec_type = rec_type;
       this.obj_id = obj_id;
       $('#recsub').val(subject);
       $('#recsub').attr('readonly', false);
       $('#recmessage').val(message);
       $('#touser').val('');
       $('#recmessage').height(130);
       this.setHeader(rec_type);
       $('#recommenddialog').modal('show');
     },

     send: function () {
       var that = this;
       if ($('#recsub').val() === '' || $('#recmessage').val() === '') {
         this.alert('{%trans "Please enter both a subject and a message."%}', '#recerror');
         return;
       }
       if ($('#touser').val() === '') {
         // Need proper address validation here.
         this.alert('{%trans "Please enter a valid username and/or email address. "%}', '#recerror');
         return
       }
       $('.sendrec').prop('disabled', true);
       if (this.rec_type == 'user') {
         this.url = window.ahr.app_urls.senduserrecommendation + this.obj_id;
       } else {
         this.url = window.ahr.app_urls.senditemrecommendation + this.obj_id;
       }
       var dfrd = $.ajax({
         url: that.url,
         type: 'POST',
         dataType: 'json',
         data: {
           recipients:  $('#touser').val(),
           subject:     $('#recsub').val(),
           message:     $('#recmessage').val()
         }
       });
       dfrd.done(function (data) {
         $('.sendrec').prop('disabled', false);
         if (data.success === 'true') {
           $('#touser').typeahead('destroy');
           $('#recommenddialog').modal('hide');
         }
         else {
           if (data.badrecipients.length == 1) {
             that.alert('{%trans "Failed to send message to user:"%} ' + data.badrecipients[0], '#recerror');
           }
           else {
             that.alert('{%trans "Failed to send message to users:"%} ' + data.badrecipients.join(', '), '#recerror');
           }
         }
       });
       dfrd.fail(function () {
         $('.sendrec').prop('disabled', false);
         that.alert('{%trans "Failed to send message"%}', '#recerror');
       });
     },

     initialize: function (data) {
       var that = this;
       this.item = data.item;
       this.url = data.url;
       window.ahr.expandTextarea('#recmessage');
       $('#recommenddialog').on('shown.bs.modal',function(){
        $('#recmessage').trigger('focus');
      });
     }
   });
   window.ahr.recommend_widget = window.ahr.recommend_widget || {};
   window.ahr.recommend_widget.initWidget = function (fromuser, item, url) {
     var widget = new RecommendDialog({
       'fromuser': fromuser,
       'item': item,
        url: url
     });
     return widget;
   };
 })();
</script>
