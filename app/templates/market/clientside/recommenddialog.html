{% load i18n %}
{% load compress %}

<div id="recommenddialog" class="modal fade">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
        <h4 class="modal-title">{%trans "Recommed this"%}<span id="rec-thing"></span></h4>
        <div id="recerror"></div>
      </div>
      <div class="modal-body">
        <label for="touser">{%trans "To registered user"%}</label>
        <div style="margin-bottom:5px;">
          <input  class="form-control" id="touser" type="text" name="subject" required="true"/>
        </div>

        <label for="recsub">{%trans "Subject"%}</label>
        <div style="margin-bottom:5px;">
          <input  class="form-control" id="recsub" type="text" name="subject" required="true"/>
        </div>
        <label for="recmessage">{%trans "Message"%}</label>
        <div>
          <textarea class="form-control" name="recmessage" id="recmessage" rows="4" placeholder="" required="true"></textarea>
        </div>
        <div class="modal-footer">
          <div class="row">
            <div class="col-xs-6 col-md-offset-6 col-md-3">
              <button type="button" class="btn full-width cancelrec" data-dismiss="modal">{%trans "Cancel"%}</button>
            </div>
            <div class="col-xs-6 col-md-3">
              <button type="button" class="btn full-width btn-default sendrec">{%trans "Send"%}</button>
            </div>
          </div>
        </div>
      </div>
    </div><!-- /.modal-content -->
  </div><!-- /.modal-dialog -->
</div><!-- /.modal -->

{% compress js inline %}

<script type="text/javascript" id="recommend_view">
 (function () {
   var RecommendDialog = window.ahr.BaseView.extend({
     el: 'body',
     events: {
       'click .sendrec': 'send',
       'click .recommend': 'show'
     },

     show: function(ev){
      var subject = ev.currentTarget.getAttribute('subject'),
        message = ev.currentTarget.getAttribute('message'),
        obj_id = ev.currentTarget.getAttribute('obj_id'),
        rec_type = ev.currentTarget.getAttribute('rec_type');
      this.setup(rec_type, obj_id, subject, message);
     },

     setHeader: function(rec_type){
      var dialog_header;
      if(rec_type === "user"){
        dialog_header = ' user';
      }else{
        dialog_header = ' post';
      }
      $('#rec-thing').text(dialog_header);
     },

     setup: function (rec_type, obj_id, subject, message) {
       $('#touser').typeahead({
         remote: window.ahr.app_urls['getusernames'] + '?username=%QUERY'
       });
       $('.sendrec').prop('disabled', false);
       this.rec_type = rec_type;
       this.obj_id = obj_id;
       $('#recsub').val(subject);
       $('#recsub').attr('readonly', false);
       $('#recmessage').val(message);
       $('#touser').val('');
       $('#recmessage').height(100);
       this.setHeader(rec_type);
       $('#recommenddialog').modal('show');
     },

     send: function () {
       var that = this;
       $('.sendrec').prop('disabled', true);
       if ($('#touser').val() !== '' && $('#recsub').val() !== '' && $('#recmessage').val() !== '') {
         if (this.rec_type == 'user') {
           this.url = window.ahr.app_urls.senduserrecommendation.replace('0', $('#touser').val()) + this.obj_id;
         } else {
           this.url = window.ahr.app_urls.senditemrecommendation.replace('0', $('#touser').val()) + this.obj_id;
         }
         window.ahr.getcsrf(function (csrf) {
           var dfrd = $.ajax({
             url: that.url,
             type: 'POST',
             dataType: 'json',
             data: {
               csrfmiddlewaretoken: csrf.csrfmiddlewaretoken,
               subject: $('#recsub').val(),
               message: $('#recmessage').val()
             }
           });
           dfrd.done(function () {
             $('#recommenddialog').modal('hide');
             $('.sendrec').prop('disabled', false);
             $('#touser').typeahead('destroy');
           });
           dfrd.fail(function () {
             $('.sendrec').prop('disabled', false);
             that.alert('{%trans "Failed to send message"%}', '#recerror');
           });
         });
       } else {
         this.alert('{%trans "Please enter both a subject and a message."%}', '#recerror');
       }
     },

     initialize: function (data) {
       var that = this;
       this.item = data.item;
       this.url = data.url;
       window.ahr.expandTextarea('#recmessage');
       $('#recommenddialog').on('shown.bs.modal',function(){
        $('#recmessage').trigger('focus');
      });
     }
   });
   window.ahr.recommend_widget = window.ahr.recommend_widget || {};
   window.ahr.recommend_widget.initWidget = function (fromuser, item, url) {
     var widget = new RecommendDialog({
       'fromuser': fromuser,
       'item': item,
       url: url
     });
     return widget;
   };
 })();
</script>
{% endcompress %}