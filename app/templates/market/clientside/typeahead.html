<script type="text/template" id="typeahead_template">
  <div class="col-md-12">
    <div class="<%- item %> error"></div>
  </div>
  <div class="col-md-12">
    <label for="<%- item %>"><%- title %></label>
    <div class="input-group">
      <input id="<%- item %>" class="form-control input-sm typeaheadtag_input" type="text"/>
      <span class="input-group-addon">
        <span class="glyphicon <%- item %>">Add</span>
      </span>
    </div>
  </div>
  <div class="col-md-12" style="margin-top:5px">
    <div class="input-group" id="<%- item %>Tags"></div>
  </div>
</script>

<script type="text/javascript" id="typeahead_view">
  (function(){

    var TypeaheadWidget = window.ahr.BaseView.extend({
        tagdict: {},
        change:function(values){
            var that = this;
            this.empty();
            this.setPrefilledVals(values);
            for(i in this.pref){
                $('#'+that.settings.jsonfield,$(this.container)).tagsManager('pushTag',this.pref[i]);
            }

        },

        typeAheadTemplate: function(title,  item){
            if (this.typeAheadTag  === undefined){
                this.typeAheadTag = _.template($('#typeahead_template').html());
            }
            return this.typeAheadTag({'title':title,'item':item});
        },

        makeTypeAhead: function(name, func){
            var that = this;
            that.typeahead = $('#'+name,$(this.container)).typeahead({
                minLength: 0,
                limit: 17,
                local: that.typeaheadval});

            function afterselect(d){
                $('#'+name,$(that.container)).data().ttView.setQuery('');
                $('#'+name,$(that.container)).trigger('blur');
                $('#'+name,$(that.container)).tagsManager("pushTag", d.value);
                // $('#'+name,$(that.container)).trigger('focus');
            }

            that.typeahead.on('typeahead:selected', function (e, d) {
                afterselect(d);
            });

            that.typeahead.on('typeahead:autocompleted',function(e,d){
                afterselect(d);
            });

            // that.typeahead.blur(function(){
                // $('#'+name,$(that.container)).val('');
            // });

            func(this.values);
        },

        setPrefilledVals:function(prefilled){
            var pref=[];
            inv = this.invert(this.tagdict);
            _.each(prefilled,function(id){
                pref.push(inv[id]);
            });
            this.pref = pref;
        },

        makeWidget: function (name, prefilled){
            var that = this;
            this.makeTypeAhead(name, function(data){
                var pref=[];
                that.values = data;
                if (prefilled){
                    inv = that.invert(that.tagdict);
                    _.each(prefilled,function(id){
                        pref.push(inv[id]);
                    });
                }

                $('#'+name,$(that.container)).tagsManager({
                    tagsContainer: that.container+' #'+name+'Tags',
                    deleteTagsOnBackspace: false,
                    blinkBGColor_1: '#FFFF9C',
                    blinkBGColor_2: '#CDE69C',
                    hiddenTagListName: 'hidden-'+name+'_'+that.container,
                    prefilled: pref,
                    validator:function(tag){
                        if (that.values.indexOf(tag)!=-1){
                            return true;
                        }else{
                            return false;
                        }
                    }
                });

            });
        },

        empty:function(){
            $('#'+this.settings.jsonfield,$(this.container)).tagsManager('empty');
        },

        getval:function(){
            return this.getTagIds();
        },

        getTagIds: function(){
            var that = this;
            var val_ids=[],
                val_names = $('input[name="hidden-'+this.settings.jsonfield+'_'+this.container+'"]',$(this.container)).val().split(',');
            _.each(val_names,function(val){
                val_ids.push(that.tagdict[val]);
            });
            return val_ids;
        },

        initialize: function(initobj){
            this.container = initobj.container;
            this.settings = initobj.settings;
            this.preset = initobj.preset;
            this.typeaheadval = [];
            this.values=[];
            this.tagdict={};
            var data = window.ahr[initobj.settings.jsonfield];
            for (var i = 0; i < data.length; i++){
                this.typeaheadval.push({
                    tokens: [data[i].value,],
                    value: data[i].value
                });
                this.values.push(data[i].value);
                this.tagdict[data[i].value]=data[i].pk;
            }
            $(this.container).html(this.typeAheadTemplate(this.settings.title, this.settings.jsonfield));
            this.makeWidget(this.settings.jsonfield, this.preset? this.preset: null);
        }

    });

    window.ahr.typeahead_widget = window.typeahead_widget|| {};
    window.ahr.typeahead_widget.initWidget= function(container,settings,preval){
        var widget = new TypeaheadWidget({'container':container,'settings':settings,'preset':preval});
        return widget;
    };
})();
</script>