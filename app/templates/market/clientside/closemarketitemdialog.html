{% load i18n %}
{% load compress %}

<div id="close_item_dialog" class="modal fade">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
        <h4 class="modal-title">
          <span id="close_modal_title"
                data-request_title="{%trans "CLOSE A REQUEST"%}"
                data-offer_title="{%trans "CLOSE AN OFFER"%}"></span>
        </h4>
      </div>
      <div class="modal-body">
        <form class="form-horizontal" role="form" id="questionnaire_form"></form>
      </div>
    </div>
  </div>
</div>

<script type="text/template" id="close-item-form-template">
  <div id="itemformerror"></div>
  <div class="form-group"><%- title %></div>
  <% _.each(questions, function(question) { %>
      <div class="form-group" id="question_<%- question.question_id %>"></div>
  <% }); %>
  <div class="modal-footer">
    <span class="col-xs-offset-6 col-xs-6 pull-right">
      <div class="row">
        <button type="submit" class="btn btn-default full-width pull-right item-close">{% trans "Close" %}</button>
      </div>
    </span>
  </div>
</script>

{% compress js inline %}
<script type="text/javascript">
(function(){
    var CloseItemDialogView = window.ahr.item_form_base.extend({
        el: '#close_item_dialog',

        events: {
          'hide.bs.modal': 'dialogClosing'
        },

        dialogClosing: function(ev){
          ev.stopImmediatePropagation();
          this.emptyTheForm();
        },

        init: function () {
          _.extend(this.events,{

          });
        },

        close: function(item_id, item_type, close_url, callback){
          $('#' + this.el.id + ' #itemformerror').empty();
          $('#' + this.el.id + ' .error').empty();

          this.item_id = item_id;
          this.item_type = item_type;
          this.url = close_url;
          this.del_callback = callback;

          $.ajax({
            url: this.url,
            context: this,
            success: this.setQuestionnaire
          });
        },

        setQuestionnaire: function(data) {
          this.questionnaire = data.questionnaire;
          var templateArgs = {
            title: this.questionnaire.questionnaire_title,
            questions: this.questionnaire.questions
          };
          var questionnaire_form = _.template($('#close-item-form-template').html(), templateArgs);
          $('#questionnaire_form').html(questionnaire_form);

          this._makeWidget();
          this.showModal();
        },

        _makeWidget: function () {
            var widgets = {},
                widget;
            var questions = this.questionnaire.questions;
            for (var i in questions) {
                var question = questions[i];
                widget = window.ahr.textarea_widget.initWidget(
                    '#question_' + question.question_id,
                    {title: question.question_text,
                     jsonfield: 'question_' + question.question_id,
                     placeholder: '{%trans "Please enter your answer"%}'},
                    null);
                widgets['question_' + question.question_id] = widget;
            }
            this.widgets = widgets;
        },

        showModal: function () {
            this.closing = false;
            var that = this;
            $('#' + that.el.id + ' #itemformerror').empty();
            var $close_modal_title = $('#close_modal_title');
            $close_modal_title.text($close_modal_title.data(this.item_type + '_title'));

            that.$el.modal('show');
            window.ahr.getcsrf(function (csrf) {
                if (csrf == false) {
                    that.alert('{%trans "Unable to connect to the server. please try again in a few minutes"%}','#infobar');
                    return;
                }
                that.csrf = csrf.csrfmiddlewaretoken;
            });
        },

        getFormData: function(){
          var retdict = {};
          var widgets = this.widgets;
          for (var i in widgets) {
              var widget = widgets[i];
              retdict[i] = widget.getval();
          }
          retdict.csrfmiddlewaretoken = this.csrf;
          return retdict;
        },

        emptyTheForm: function () {
          $('input,textarea', $('#requestdialog')).val('');
        },

        initialize: function () {
          this.changing = false;
          this.widgets = [];
          _.extend(this.events, {
            'submit': 'submit'
          });
          this.init();
        },

        aftersubmit: function(){
          this.closing = true;
          this.$el.modal('hide');
          this.emptyTheForm();
          if (typeof this.del_callback == "function") {
              this.del_callback(this.item_id);
          }
        }
    });

    window.ahr.close_marketitem_form_dialog = window.ahr.close_marketitem_form_dialog || {};
    window.ahr.close_marketitem_form_dialog.initItem = function(item){
        return new CloseItemDialogView(item);
    };
})();
</script>
{% endcompress %}
