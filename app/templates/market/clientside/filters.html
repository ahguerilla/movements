{% load i18n %}

{% load compress %}
<script type="text/template" id="filters_template">
<div id="action-wrapper">
    <div id="fixed-actions">
      <div class="exchange-actions" >
        <div class="container">
          <div class="row">
            <div id="create_offer" class="market-action pull-left">
              <img src="{{ STATIC_URL }}images/offer-button-30x30.png" alt="{%trans "Create an offer"%}" />
              <span>{%trans "Create an offer"%}</span>
            </div>
            <div id="create_request" class="market-action pull-left">
              <img src="{{ STATIC_URL }}images/request-button-30x30.png" alt="{%trans "Create a request"%}" />
              <span>{%trans "Create a request"%}</span>
            </div>
            <div id="filter-actions" class="right-on-big">
              <div class="filter-posts">
                <button type="button"class="btn btn-success btn-default btn-xs item-type btn-group-justified" item_type="Request">
                  <span id="filter-request-text">&nbsp; {% trans "Show Requests" %} &nbsp;</span>
                </button>
              </div>
              <div class="filter-posts">
                <button type="button" class="btn btn-success btn-default btn-xs item-type btn-group-justified" item_type="Offers">
                  <span id="filter-offer-text">&nbsp; {% trans "Show Offers" %} &nbsp;</span>
                </button>
              </div>
              <div class="filter-posts" id="showhide-hidden-container">
                <button class="btn btn-default btn-xs btn-group-justified" id="filter-show-hidden">Show hidden</button>
              </div>
            </div>
          </div>
        </div>
      </div>
      <div class="filter-banner-spacer-black"></div>
      <div class="grayback">
        <div class="container">
          <div id="info-panel-container">
            <div id="current-filters">Filters: <span id="filters-exp"></span></div>
            <div>
              <div id="filter-info-panel">
                <span class="filt-inf-wrapper first">
                  <span id="activate-issues-filters"></span>
                </span>
                <span class="filt-inf-wrapper">
                  <span id="activate-countries-filters"></span>
                </span>
                <span class="filt-inf-wrapper">
                  <span id="activate-skills-filters"></span>
                </span>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</script>


{% compress js inline %}
<script type="text/javascript">
  $(document).ready(function () {
  var filterWidget = Backbone.View.extend({
    filterheightOpen: 0,
    filterheightClosed: 0,
    cookieread: false,

    events:{
        'click #searchbtn': 'search',
        'click .item-type': 'itemTypesfilter',
        'click .btn.tag-button': 'itemTagClick',
        'click #filter-show-hidden': 'showHidden',
        'submit #searchform': 'filterKeySearch',
        'tm:splicing' : 'removeFilterTag',
    },

    showHidden: function(ev){
      $(ev.currentTarget).toggleClass("btn-success");
      if($(ev.currentTarget).hasClass('btn-success')){
        this.filters.showHidden = true;
      }else{
        this.filters.showHidden = false;
      }
      this.callback();
    },

    HideShowHidden: function(){
      $('#showhide-hidden-container').hide();
    },

    toggleAny: function(){
      if(this.filters.issues.length>0 || this.filters.skills.length>0 || this.filters.countries.length>0){
        $('#filters-exp').text('');
      }else{
        $('#filters-exp').text('Any');
      }
    },

    search: function () {
      this.filters.search = $('#q').val();
      this.callback();
    },

    setFiltersFromCookie: function (items) {
      var cookie = $.cookie('tagfilters');
      if (typeof cookie != 'undefined') {
        if (items != "types") {
          this.filters[items] = cookie[items];
        }
      }
    },

    filterKeySearch: function (ev) {
      ev.preventDefault();
      this.search();
      return false;
    },

    updateTypefilter: function () {
      var that = this;
      that.filters.types.length = 0;
      $('.item-type').each(function(ind, item){
        if($(item).hasClass('btn-success')){
          var item_type = item.getAttribute('item_type');
          that.filters.types.push(that.types[item_type]);
        }
      });
    },

    itemTypesfilter: function (ev) {
      $(ev.currentTarget).toggleClass('btn-success');
      this.updateTypefilter();
      this.callback();
    },

    filterButtonShowAndTog: function(ev){
      $('#togglefilter').trigger('click');
    },

    showinitFilters: function(item){
      _.each(this.filters[item],function(id, index){
        $("#activate-"+item+"-filters").tagsManager("pushTag", window.ahr[item+"_lookup"][id]);
      });
    },

    initBulkFilters: function (bulksArg) {
      var that = this;
      _.each(['countries','issues','skills'],function(item){
        that.setFiltersFromCookie.bind(that)(item);
        that.showinitFilters(item);
        that.toggleAny();
      });
    },

    removeFilterTag:function(ev, tag){
      var that = this;
      var cind = _.values(window.ahr.countries_lookup).indexOf(tag),
      iind = _.values(window.ahr.issues_lookup).indexOf(tag),
      sind = _.values(window.ahr.skills_lookup).indexOf(tag);
      if(cind > -1){
        var id = window.ahr.countries_pk[tag];
        var ind = that.filters.countries.indexOf(id);
        that.filters.countries.splice(ind,1);
      }else if(iind > -1){
        var id = window.ahr.issues_pk[tag];
        var ind = that.filters.issues.indexOf(id);
        that.filters.issues.splice(ind,1);
      }else if(sind > -1){
        var id = window.ahr.skills_pk[tag];
        var ind = that.filters.skills.indexOf(id);
        that.filters.skills.splice(ind,1);
      }
      $.cookie('tagfilters', that.filters);
      that.callback();
      that.toggleAny();
    },

    itemTagClick: function (ev) {
      var that = this;
      if (that.disable_item_click() === true) return;
      var tagType = ev.currentTarget.getAttribute('tagtype');
      var len = ev.currentTarget.textContent.length;
      var tag = ev.currentTarget.textContent.slice(1, len - 1)
      data = window.ahr[tagType];
      var tagData = _.find(data, function (test) {
        return (test.value == tag);
      });
      $('#activate-'+tagType+'-filters').tagsManager("pushTag", tag);
      that.setFilterOpenHeight();
      if (that.filters[tagType].indexOf(tagData.pk) < 0){
        that.filters[tagType].push(tagData.pk);
        $.cookie('tagfilters', that.filters);
        that.toggleAny();
        that.callback();
      }else{
        $('.tm-tag-remove',$('#info-panel-container .tm-tag:contains('+tag+')')).trigger('click');
      }

    },

    setFilterOpenHeight: function () {
      $('#market-filters').removeClass('collapse');
      if($('#market-filters').css('height')=='0px'){
        $('#market-filters').css('height','auto');
        this.filterheightOpen = $("#fixed-actions").height();
        $('#market-filters').css('height','0px');
        $('#market-filters').addClass('collapse');
      }else{
        this.filterheightOpen = $("#fixed-actions").height();
        $('#market-filters').addClass('collapse');
      }
    },

    setFilterWrapperMargin: function (height, speed, callback) {
      $('#action-wrapper').animate({
        height: height
      }, speed, callback);
    },

    initTemplates: function () {
      this.typetag_tmp = _.template($('#type-tag').html());
      this.tagtemp = _.template($('#filter-tag').html());
      this.cookieread = true;
    },

    initAll:function(){
      this.all={};
      this.all.skills = _.keys(window.ahr.skills_lookup).map(function(item) {
        return parseInt(item, 10);
      });
      this.all.issues = _.keys(window.ahr.issues_lookup).map(function(item) {
        return parseInt(item, 10);
      });
      this.all.countries = _.keys(window.ahr.countries_lookup).map(function(item) {
        return parseInt(item, 10);
      });
    },

    initHeights: function(){
      var that = this;
      var tmpl = _.template($('#filters_template').html());
      var html = tmpl({});
      $('#' + this.container).html(html);
      var resizeFilters = function () {
        that.setFilterOpenHeight();
        var newHight = $('#fixed-actions').height();
        $('#action-wrapper').height( newHight+ "px");
      };
      // calculate height of the market-filters when opened and closed so we can set
      // the height of the market-filter correctly when we fix it to the top
      this.filterheightClosed = $('#fixed-actions').height();
      this.setFilterOpenHeight();
      $('#action-wrapper').height(this.filterheightClosed + "px");
      $.subscribe("filters.resize", resizeFilters);
      $(window).resize(resizeFilters);
      $('#fixed-actions').affix({
        offset: {
          top: 155
        }
      });
    },

    initialize: function (data) {
      var that = this;
      $.cookie.json = true;
      this.initAll();
      this.container = data.container;
      this.filters = data.filters;
      this.filters.countries = [];
      this.filters.issues = [];
      this.filters.skills = [];
      this.first_types = data.filters.types;
      this.initTemplates(data.filters);
      this.default_filters = data.default_filters;
      this.callback = data.callback;
      this.disable_item_click = data.disable_item_click;
      this.filters.search = $('#q').val();
      this.filters.showHidden = false;
      this.initHeights();
      $("#activate-issues-filters").tagsManager();
      $("#activate-countries-filters").tagsManager();
      $("#activate-skills-filters").tagsManager();
    }
  });

  window.widgets = window.widgets || {};
  window.widgets.filter_widget = window.widgets.filter_widget || {};
  window.widgets.filter_widget.initWidget = function (container, el, filters, default_filters, callback, disable_item_click) {
    var widget = new filterWidget({
      'el': el,
      'container': container,
      'filters': filters,
      'default_filters': default_filters,
      'callback': callback,
      'disable_item_click':  disable_item_click
    });
    return widget;
  };
});
</script>
{% endcompress %}