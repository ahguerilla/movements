{% load i18n %}
{% load avatar_tags %}
{% load compress %}

<div id="ratedialog" class="modal fade">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
        <h4 class="modal-title">{%trans "Rate"%} <span id="ratetitle"></span></h4>
        <div id="rateerror"></div>
      </div>
      <div class="modal-body">
        <div class="row">
          <div class="round-image" style="text-align:center; font-size:160%;">
            <div style="margin-top:10px;">
              <span id="username"></span>
              <span id="numstars"></span>
              <span id="ratecount"></span>{%trans "Rating(s)"%}
            </div>
          </div>
        </div>
        <div style="margin-bottom:10px;"></div>
        <div class="row" id="rateradios" style="text-align:center;" >
          <div>
            <div>
              <label>
                <div style="display: inline-block;width:150px;text-align:left;"> <input type="radio" name="stars" value="1">{%trans "One star "%}</div>
                <div class="stars1"></div>
              </label>
            </div>
            <div>
              <label class="">
                <div style="display: inline-block;width:150px;text-align:left;"><input type="radio" name="stars" value="2">{%trans "Two stars"%}</div>
                <div class="stars2"></div>
              </label>
            </div>
            <div>
              <label class="">
                <div style="display: inline-block;width:150px;text-align:left;"><input type="radio" name="stars" value="3">{%trans "Three stars"%}</div>
                <div class="stars3"></div>
              </label>
            </div>
            <div>
              <label class="">
                <div style="display: inline-block;width:150px;text-align:left;"><input type="radio" name="stars" value="4">{%trans "Four stars"%}</div>
                <div class="stars4"></div>
              </label>
            </div>
            <div>
              <label class="">
                <div style="display: inline-block;width:150px;text-align:left;"><input type="radio" name="stars" value="5">{%trans "Five stars"%}</div>
                <div class="stars5"></div>
              </label>
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <div class="row">
            <div class="col-xs-6 col-md-offset-6 col-md-3">
              <button type="button" class="btn full-width btn-default cancelrate" data-dismiss="modal">{%trans "Cancel"%}</button>
            </div>
            <div class="col-xs-6 col-md-3">
              <button type="button" class="btn btn-default full-width sendrate">{%trans "Submit"%}</button>
            </div>
          </div>
        </div>
      </div>
    </div><!-- /.modal-content -->
  </div><!-- /.modal-dialog -->
</div><!-- /.modal -->


{% compress js inline %}
<script type="text/javascript">
(function () {
  var RateDialogView = window.ahr.BaseView.extend({
    events: {
      'click .rate': 'showrate',
      'click .sendrate': 'setrate',
      'click .cancelrate': 'resetrate',
    },
    showrate: function (ev) {
      ev.preventDefault();
      this.evrate = ev;
      var username = ev.currentTarget.getAttribute('username');
      var score = ev.currentTarget.getAttribute('score');
      var ratecount = ev.currentTarget.getAttribute('ratecount');
      $('#ratecount', $('#ratedialog')).text(ratecount);

      this.rateurl = window.ahr.app_urls.setuserrate + username;
      $('#username', $('#ratedialog')).text(username);
      $('#ratetitle', $('#ratedialog')).text(username);

      $('#ratedialog').modal('show');
      $('#numstars').rateit();
      $('#numstars').rateit('min', 0);
      $('#numstars').rateit('max', 5);
      $('#numstars').rateit('readonly', true);
      $('#numstars').rateit('value', score);
      $('#numstars').rateit('starwidth', 22);
      $('#numstars').rateit('starheight', 17);

      return (false);
    },

    setrate: function (ev) {
      ev.preventDefault();
      var that = this;
      var event = ev;
      if ($('input[name="stars"]:checked',$('#ratedialog')).val() == undefined) {
        this.alert('{%trans "You have to select a rateing."%}', '#rateerror');
        return (false);
      }
      var dfrd = $.ajax({
        url: that.rateurl,
        type: 'POST',
        dataType: 'json',
        data: {
          score: $('input[name="stars"]:checked').val()
        }
      });
      dfrd.done(function (data) {
        $(that.evrate.currentTarget).attr('ratecount', data.ratecount);
        $(that.evrate.currentTarget).attr('score', data.score);
        if (typeof that.callback == 'function') {
          that.callback(that.evrate.currentTarget.getAttribute('username'), data.score);
          $.noop();
        }

        $('#ratedialog').modal('hide');
        var username = that.evrate.currentTarget.getAttribute('username')
        that.resetrate(username , data.score, data.ratecount);
      });
      dfrd.fail(function (data) {
        that.alert('{%trans "Rating failed."%}', '#rateerror');
      });
      return (false);
    },

    resetrate: function (username, score, ratecount) {
      $('input[name="stars"]:checked',$('#ratedialog')).prop('checked', false);
      $('.numstars[username="'+username+'"]').attr('score',score);
      $('.numstars[username="'+username+'"]').attr('ratecount',ratecount);
      $('.rate[username="'+username+'"]').attr('score',score);
      $('.rate[username="'+username+'"]').attr('ratecount',ratecount);
      $('.score[username="'+username+'"]').text(score);
      $('.ratecount[username="'+username+'"]').text(ratecount)
    },

    initialize: function (data) {
      this.callback = data.callback;
      return this;
    }

  });

  window.ahr.rate_form_dialog = window.ahr.rate_form_dialog || {};
  window.ahr.rate_form_dialog.initWidget = function (element, callback) {
    var rate_form_dialog = new RateDialogView({
      el: element,
      callback: callback
    });
    return rate_form_dialog;
  };
})();
</script>
{% endcompress %}