{% load i18n %}
{% load compress %}

<script type="text/template" id="item_template">
  <div class="market-place-item <%- item_type.toLowerCase() %> <% if(stick) { %>stuck-item<% } %> <% if (hidden) { %>hidden-item<% } %>" item_id="<%- pk %>" owner_id="<%- ownerid %>">
    <div class="market-item-card">
      <div class="body">
        <div class="item-type"><%- item_type[0].toUpperCase() + item_type.substr(1).toLowerCase() %></div>
        <div class="title"><%- title %></div>
        <div class="details">
          <%- item_type[0].toUpperCase() + item_type.substr(1).toLowerCase() %>
          by <a href="/user/profile/<%- owner %>"><%- owner %></a>, posted on <%- moment(pub_date).format('MMMM Do YYYY, h:mm a') %>, </span>
          <a href="#"><%- commentcount %> comments</a>.
        </div>
      </div>
      <a class="item-menu"><img src="{{ STATIC_URL }}images/v2/item_menu_gray_icon.png"/></a>
      <a class="share-twitter"><img src="{{ STATIC_URL }}images/v2/twitter_gray.png"/></a>
      </ul>
    </div>
  </div>

{#        {% if user.is_authenticated %}#}
{#          <% if (stick) { %>#}
{#            <a href="<%- window.ahr.app_urls.setMarketItemunStick+pk %>" item_id="<%- pk %>" class="marketitem-unstick toggle-stick pull-right">Unstick</a>#}
{#          <% } else { %>#}
{#            <a href="<%- window.ahr.app_urls.setMarketItemStick+pk %>" item_id="<%- pk %>" class="marketitem-stick toggle-stick pull-right">Stick</a>#}
{#          <% } %>#}
{#          <% if (hidden) { %>#}
{#            <a clas href="<%- window.ahr.app_urls.setMarketItemunHide+pk %>" item_id="<%- pk %>" class="show-hidden-item-link unhide-item toggle-hidden">Show</a>#}
{#          <% } else { %>#}
{#            <a href="<%- window.ahr.app_urls.setMarketItemHide+pk %>" item_id="<%- pk %>" class="hide-item toggle-hidden">Hide</a>#}
{#          <% } %>#}
{#        {% endif %}#}

</script>


{% compress js inline %}
<script type="text/javascript">
(function () {
  var MarketItemWidget = window.ahr.BaseView.extend({

{#    confirmLeave:function(ev){#}
{#      ev.preventDefault();#}
{#      if(ev.currentTarget.href.slice(0,29) != window.ahr.current_site.slice(0,29)){#}
{#        if(confirm(window.ahr.string_constants.redirect_off_site)){#}
{#          window.open(ev.currentTarget.href, '_blank');#}
{#        }#}
{#      }#}
{#      return false;#}
{#    },#}

    {% if user.is_authenticated %}

      getCommentData: function () {
        var dfrd = $.Deferred();
        window.ahr.getcsrf(function (csrf) {
          dfrd.resolve(csrf);
        });
        return dfrd;
      },

      comment: function (ev) {
        ev.preventDefault();
        var id = $(ev.currentTarget).data().id;
        var comment = $('#newcomment').val();
        var that = this;
        if (comment) {
          var dfrd = this.getCommentData();
          dfrd.done(function (csrf) {
            $.ajax({
              type: 'POST',
              url: window.ahr.app_urls.addcomment + id,
              dataType: 'json',
              data: {
                "csrfmiddlewaretoken": csrf.csrfmiddlewaretoken,
                "contents": comment
              },
              success: function (item) {
                $('#newcomment').val("");
                $('#newcomment').height(100);
                that.addCommentToCommentList(item.obj, true);
                that.setCommentCount(id);
              }
            });
          });
        }
        return (false);
      },

      setCommentCount: function (id) {
        $.getJSON(
          window.ahr.app_urls.getcommentcount + id,
          function (data) {
            $('.market-item-card[item_id="' + id + '"] .item-comment-count .commentcount').text(data);
          });
      },

{#      deleteComment: function (ev) {#}
{#        ev.preventDefault();#}
{#        var that = this;#}
{#        if (confirm('{% trans "Are you sure you want to delete your comment?" %}')) {#}
{#          var comment_id = ev.currentTarget.getAttribute('comment-id');#}
{#          var href = ev.currentTarget.href;#}
{#          var dfrd = $.ajax({#}
{#            url: href#}
{#          });#}
{#          dfrd.success(function (data) {#}
{#            $('.comment[comment-id="' + comment_id + '"]').remove();#}
{#          });#}
{#        }#}
{#        return false;#}
{#      },#}

      addCommentToCommentList: function (comment_item, front) {
        front = front === true ? front : false;
        var data = {
          pk: comment_item.pk,
          userpic: comment_item.fields.avatar,
          user: comment_item.fields.username,
          owner: comment_item.fields.owner,
          owner_url: comment_item.fields.profile_url,
          pub_date: moment(comment_item.fields.pub_date).format("HH:mm on D/MM/YY"),
          content: comment_item.fields.contents, //.replace(/\n/g, '<br />')
          score: comment_item.score,
          username: comment_item.fields.username,
          ownerid : comment_item.fields.ownerid,
          ratecount: comment_item.ratecount,
          avatar: comment_item.fields.avatar
        };
        var comment_html = this.comment_tmp(data);
        var actions = this.market.actions_view.get('comment', data);
        var $comment_html = $(comment_html);
        $comment_html = $comment_html.clickUrl();
        $comment_html.find('.commentaction-place').replaceWith(actions);
        if (front) {
          $('#marketitem_comments').prepend($comment_html);
        } else {
          $('#marketitem_comments').append($comment_html);
        }
      },

      resetitemrate: function (username, rate) {
        try {
          $(".numstars[username=" + username + "]").each(function () {
            $(this).rateit('value', rate);
            $(this).attr('rate', rate);
          });
        } catch (err) {
          $.noop();
        }
      },

{#      deleteItem: function (ev) {#}
{#        ev.preventDefault();#}
{#        var that = this;#}
{#        if (confirm('{% trans "Are you sure you want to delete this item?" %}')) {#}
{#          var item_id = ev.currentTarget.getAttribute('item_id');#}
{#          var dfrd = $.ajax({#}
{#            url: window.ahr.app_urls.deletemarketitem + item_id,#}
{#          });#}
{#          dfrd.done(function (data) {#}
{#            if (typeof that.del_callback == "function") {#}
{#              that.del_callback(item_id);#}
{#            }#}
{#          });#}
{#        }#}
{#        return (false);#}
{#      },#}
{##}
{#      editItem: function (ev) {#}
{#        ev.preventDefault();#}
{#        var that = this;#}
{#        var id = ev.currentTarget.getAttribute('item_id');#}
{#        $.getJSON(window.ahr.app_urls.getuseritem + id, function (item) {#}
{#          if (item[0].fields.item_type == "request") {#}
{#            that.market.requestdialog.edit(item, that.edit_callback);#}
{#            that.market.requestdialog.showModal();#}
{#          } else {#}
{#            that.market.offerdialog.edit(item, that.edit_callback);#}
{#            that.market.offerdialog.showModal();#}
{#          }#}
{#        });#}
{#        return (false);#}
{#      },#}

      reloadItem: function (item) {
        return this.item_tmp(item[0].fields);
      },

{#      showMoreTags: function(ev){#}
{#        var item = $(ev.currentTarget).closest('.more-items-here');#}
{#        item.removeClass('more-items-here');#}
{#        this.market.fancyref();#}
{#        $(ev.currentTarget).replaceWith('<div class="showlesstags">{% trans "Less ..." %}</div>');#}
{#      },#}
{##}
{#      showLessTags: function(ev){#}
{#        var item = $(ev.currentTarget).closest('.item-tags.clearfix');#}
{#        item.addClass('more-items-here');#}
{#        this.market.fancyref();#}
{#        $(ev.currentTarget).replaceWith('<div class="showmoretags">{% trans "More ..." %}</div>');#}
{#      },#}
    {% endif %}


{#    afterset: function (item_container) {#}
{#      if(this.market.isSingle()){#}
{#        var title = $('.marketitem_title',$('#singleItem')).text();#}
{#        $('#marketitem_title_breadc').text(title);#}
{#      }#}
{#      return;#}
{#    },#}

{#    {% if user.is_authenticated %}#}
{##}
{#      toggleHidden:  function(ev){#}
{#        ev.preventDefault();#}
{#        var that = this;#}
{#        var id = ev.currentTarget.getAttribute('item_id');#}
{#        $.getJSON(ev.currentTarget.href,function(data){#}
{#          if(data.result===true){#}
{#            if($(ev.currentTarget).hasClass('hide-item')){#}
{#              if(that.market.isShowingHidden()){#}
{#                $(ev.currentTarget).closest('.market-item-card').addClass('hidden-item');#}
{#                $(ev.currentTarget).closest('.item-header').addClass('hidden-item');#}
{#                $(ev.currentTarget).closest(".show-hidden-item-link");#}
{#                $(ev.currentTarget).replaceWith('<a href="'+window.ahr.app_urls.setMarketItemunHide+id+'" item_id="'+id+'" class="hidden-item toggle-hidden">Show</a>');#}
{#              }else{#}
{#                that.del_callback(id);#}
{#              }#}
{#            }else{#}
{#              $(ev.currentTarget).closest('.market-item-card').removeClass('hidden-item');#}
{#              $(ev.currentTarget).closest('.item-header').removeClass('hidden-item');#}
{#              $(ev.currentTarget).closest(".show-hidden-item-link");#}
{#              $(ev.currentTarget).replaceWith('<a href="'+window.ahr.app_urls.setMarketItemHide+id+'" item_id="'+id+'" class="hide-item toggle-hidden">Hide</a>');#}
{#            }#}
{#          }#}
{#        });#}
{#        return false;#}
{#      },#}
{##}
{#      toggleStick: function(ev){#}
{#        ev.preventDefault();#}
{#        var that = this;#}
{#        var id = ev.currentTarget.getAttribute('item_id');#}
{#        $.getJSON(ev.currentTarget.href,function(data){#}
{#          if($(ev.currentTarget).hasClass('marketitem-unstick')){#}
{#            $(ev.currentTarget).replaceWith('<a href="'+window.ahr.app_urls.setMarketItemStick+id+'" item_id="'+id+'" class="marketitem-stick toggle-stick pull-right">Stick</a>');#}
{#          }else{#}
{#            $(ev.currentTarget).replaceWith('<a href="'+window.ahr.app_urls.setMarketItemunStick+id+'" item_id="'+id+'" class="marketitem-unstick toggle-stick pull-right">Unstick</a>');#}
{#          }#}
{#        });#}
{#      },#}
{#    {% endif %}#}


    initialize: function (options) {
      this.item_type = 'item';
      this.market = options.market;
{#      this.del_callback = options.del_callback;#}
{#      this.edit_callback = options.edit_callback;#}
      this.item_tmp = _.template($('#item_template').html());

      {% if user.is_authenticated %}
{#        this.message_widget = window.ahr.messagedialog_widget.initWidget('body', '#infobar');#}
{#        this.rate_widget = window.ahr.rate_form_dialog.initWidget('body', this.resetitemrate.bind(this));#}
{#        this.report_dialog = window.ahr.report_dialog.initWidget('body');#}

{#        this.comment_tmp = _.template($('#comment_view_template').html());#}
{#        this.comment_form_tmp = _.template($('#comment_add_template').html());#}
{#        $('#marketitem_comment_form').html(this.comment_form_tmp());#}
{#        window.ahr.expandTextarea('#newcomment');#}

        _.extend(this.events, {
{#          'click .toggle-hidden': 'toggleHidden',#}
{#          'click .toggle-stick': 'toggleStick',#}
{#          'click .comment-btn': 'comment',#}
{#          'click .comment-delete': 'deleteComment',#}
{#          'click .delete': 'deleteItem',#}
{#          'click .edit': 'editItem',#}
{#          'click .showmoretags': 'showMoreTags',#}
{#          'click .showlesstags': 'showLessTags',#}
{#          'click .multi-line-text a': 'confirmLeave',#}
{#          'click .comment-content a': 'confirmLeave'#}
        });
      {% endif %}

    }
  });

  window.ahr.marketitem_widget = window.ahr.marketitem_widget || {};
  window.ahr.marketitem_widget.initWidget = function (element, market, del_callback, edit_callback) {
    var marketitem_widget = new MarketItemWidget({
      el: element,
      market: market,
      del_callback: del_callback,
      edit_callback: edit_callback
    });
    return marketitem_widget;
  };

})();
</script>
{% endcompress %}
