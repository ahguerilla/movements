<script type="text/template" id="item_template">
  <div class="market-place-item item-wrap" item_id="<%- pk %>" owner_id="<%- ownerid %>">
    <div class="market-item-card" item_id="<%- pk %>" owner_id="<%- ownerid %>">
      <div class="item-header <%- item_type.toLowerCase() %>">
        <div class="item-header-clickable item_container" item_id="<%- pk %>">
          <%- item_type.toUpperCase() %>&nbsp;
          <span>by&nbsp;<a href="/user/profile/<%- owner %>"><%- owner %> </a></span> 
          <span item_id="<%- pk %>"  score="<%-usercore%>" class="numstars"></span>
        </div>
        <div class="pull-right item-menu" style="position:relative;">
          <div item_id="<%- pk %>" class="pull-right glyphicon glyphicon-align-justify itemactions"></div>
          <div class="dropdown">
            <button class="btn dropdown-toggle sr-only" type="button" id="dropdownMenu<%- pk %>" data-toggle="dropdown" />
            <ul class="dropdown-menu" role="menu" aria-labelledby="dropdownMenu<%- pk %>">
              <% if (ownerid != window.ahr.user_id){ %>
                <li role="presentation"></li>
                <li role="presentation"><a owner="<%- owner %>" title="<%- title %>" class="recommend" role="menuitem" tabindex="-1" href="#">Recommend</a></li>
                <li role="presentation"><a item_id="<%- pk %>" class="report_post" role="menuitem" tabindex="-1" href="#">Report post</a></li>
                <li role="presentation"><a item_id="<%- pk %>" rateing="user" username="<%- owner %>"  score="<%- usercore %>" ratecount="<%- ratecount %>" class="rate rate_user" role="menuitem" tabindex="-1" href="#">Rate user</a></li>
                <li role="presentation"><a item_id="<%- pk %>" owner="<%- owner %>" class="private_message" role="menuitem" tabindex="-1" href="#">Private message</a></li>
              <%}%>
              <% if (ownerid == window.ahr.user_id){ %>
                <li role="presentation"></li>
                <li role="presentation"><a item_id="<%- pk %>" class="delete" role="menuitem" tabindex="-1" href="#">Delete</a></li>
                <li role="presentation"><a item_id="<%- pk %>" class="edit" role="menuitem" tabindex="-1" href="#">Edit</a></li>
              <%}%>
            </ul>
          </div>
        </div>
      </div>
      <div class="item_container" item_id="<%- pk %>">
        <div class="item-title" owner_id="<%- ownerid %>">
          <div class="item-icon <%- item_type.toLowerCase() %>"></div>
          <div class="marketitem_title"><%- title %></div>
        </div>
        <div class="clearfix"></div>
        <div class="item-body"><%- details %></div>
        <div class="item-tags">
          <div class="item-comment-count"><%- commentcount %> Comment<% if (commentcount != 1){ %>s<%}%></div>
          <div>
            <% _.each(issues, function(ind) { %> <div class="btn btn-default disabled btn-xs"> <%- window.ahr.issues_lookup[ind] %> </div> <% }); %>
            <% _.each(countries, function(ind) { %> <div class="btn btn-default disabled btn-xs"> <%- window.ahr.countries_lookup[ind] %> </div> <% }); %>
            <% _.each(skills, function(ind) { %> <div class="btn btn-default disabled btn-xs"> <%- window.ahr.skills_lookup[ind] %> </div> <% }); %>
          </div>
        </div>
      </div>
    </div>
  </div>
</script>

<script type="text/javascript">
(function(){
    var MarketItemWidget =  window.ahr.BaseView.extend({

      getCommentData: function(){
        var dfrd = $.Deferred();
        window.ahr.getcsrf(function(csrf){
          dfrd.resolve(csrf);
        });
        return dfrd;
      },

      comment: function(){
        var comment = $('#newcomment').val();
        var that = this;
        if(comment){
          var dfrd = this.getCommentData();
          dfrd.done(function(csrf){
            $.ajax({
              type: 'POST',
              url: window.ahr.app_urls.addcomment+that.id,
              dataType:'json',
              data: {
                "csrfmiddlewaretoken":csrf.csrfmiddlewaretoken,
                "contents": comment
              },
              success: function(item){
                $('#newcomment').val("");
                $('#newcomment').height(100);
                that.addCommentToCommentList(item.obj, true);
              }
            });
          });
        }
      },

      deleteComment:function(ev){
        var that = this;
        if(confirm('Are you sure you want yo delete your comment?')){
          var comment_id =  ev.currentTarget.getAttribute('comment-id');
          var aurl = $('a',$(ev.currentTarget))[0];
          var dfrd = $.ajax({url:aurl.href});
          dfrd.success(function(data){
            that.alert('Your comment was deleted.','#itemdialogerror');
            $('.comment[comment-id="'+comment_id+'"]').remove();
          });
        }
        return false;
      },

      addCommentToCommentList: function(comment_item, front){
        front = front === true ? front : false;
        var comment_html = this.comment_tmp({pk:comment_item.pk,
          userpic: comment_item.fields.avatar,
          user: comment_item.fields.username,
          owner: comment_item.fields.owner,
          owner_url: comment_item.fields.profile_url,
          pub_date: moment(comment_item.fields.pub_date).format("HH:mm on D/MM/YY"),
          content: comment_item.fields.contents//.replace(/\n/g, '<br />')
        });

        if(front){
          $('#marketitem_comments').prepend(comment_html);
        } else {
          $('#marketitem_comments').append(comment_html);
        }
      },

      show: function(id){
        var that = this;
        that.id =  id;

        $('#marketitem_comments').empty();
        $.getJSON(
          window.ahr.app_urls.getmarketitem+id,
          function(data){
            var html = that.item_tmp(data[0].fields);
            $('#marketitem_place').html(html);
            $('.delete',$('#marketitemdialog')).hide();
            $.getJSON(window.ahr.app_urls.getcommentslast.replace('0',id)+'100',function(data){
            _.each(data, function(comment){
              that.addCommentToCommentList(comment);
            });
          });
          $('#newcomment').height(100);
          $('#marketitemdialog').modal('show');
        });
      },

      show_dropdown:function(ev){
        ev.preventDefault();
        var item_id = ev.currentTarget.getAttribute('item_id');
        $('#dropdownMenu'+item_id).trigger('click');
        return false;
      },

      private_message: function(ev){
        var username = ev.currentTarget.getAttribute('owner');
        var item_id = ev.currentTarget.getAttribute('item_id');
        var msgsub = 'Re: '+$('.marketitem_title',$('.market-item-card[item_id='+item_id+']')).text();
        this.message_widget.show(username,msgsub,'',true);
      },

      resetitemrate:function(item_id, rate){
          try{
              $(".numstars[item_id="+item_id+"]").rateit('value',rate);
          }catch(err){
              $.noop();
          }
      },

      recommend: function(ev){
          var title = ev.currentTarget.getAttribute('title');
          $('#recsub').val($('#currentusername').text()+' recommends :'+ title);
          $('#recsub').attr('readonly',true);
          var href = '<a href="'+window.location+'">'+ title +'</a>';
          $('#recmessage').val($('#currentusername').text()+ ' recommend you have a look at this post by '+ ev.currentTarget.getAttribute('owner')+' \r\n'+ href );
          $('#touser').val('');
          $('#recommenddialog').modal('show');
      },

      deleteItem: function(ev){
          var that = this;
          if(confirm('Are you sure you want to delete this item?')){
              var item_id = ev.currentTarget.getAttribute('item_id');
              var dfrd = $.ajax({
                  url:window.ahr.app_urls.deletemarketitem+item_id,
              });
              dfrd.done(function(data){
                  that.alert('Item deleted','#infobar');
                  $(".item-wrap[item_id='"+ item_id + "']").remove();
                  that.refreshScrollElements();
              });
          }
          //that.msnry.layout();
          return(false);
      },

      editItem: function(ev){
          var that = this;
          var id = ev.currentTarget.getAttribute('item_id');
          $.getJSON(window.ahr.app_urls.getuseritem+id,function(item){
              if(item[0].fields.item_type == "request"){
                  that.market.requestdialog.edit(item);
                  that.market.requestdialog.showModal();
              }else{
                  that.market.offerdialog.edit(item);
                  that.market.offerdialog.showModal();
              }
          });
      },

      initialize: function(options){
        this.market = options.market;
        this.item_tmp = _.template($('#item_template').html());
        // this.comment_form_tmp = _.template($('#comment_add_template').html());
        // $('#marketitem_comment_form').html(this.comment_form_tmp());
        // window.ahr.expandTextarea('#newcomment');
        // this.comment_tmp = _.template($('#comment_view_template').html());
        // $('#marketitemdialog').on('hidden.bs.modal', function () {
        //   $('#marketitem_comments').empty();
        //   $('#marketitem_place').empty();
        //   $('#newcomment').val('');
        // });

        this.delegateEvents(_.extend(this.events,{
          'click .comment-btn': 'comment',
          'click .comment-delete': 'deleteComment',
          'click .itemactions' : 'show_dropdown',
          'click .private_message' : 'private_message',
          'click .recommend': 'recommend',
          'click .delete' : 'deleteItem',
          'click .edit' : 'editItem',
        }));
      }
    });

    window.ahr.marketitem_widget = window.ahr.marketitem_widget || {};
    window.ahr.marketitem_widget.initWidget= function(element,market){
        var marketitem_widget = new MarketItemWidget({el:element,market:market});
        return marketitem_widget;
    };

  })();
</script>