<script type="text/template" id="user-template">
  <div class="market-place-item" item_id="<%- pk %>" >
    <div class="market-item-card user-card" >
      <div class="item-header user">
        <div class="item-header-clickable" item_id="<%- username %>">
          <a href="<%- profile_url %>"><%- username %></a>
        </div>
        <div class="pull-right item-menu" style="position:relative;">
          <div item_id="<%- pk %>" class="pull-right glyphicon glyphicon-align-justify itemactions"></div>
          <div class="dropdown">
            <button class="btn dropdown-toggle sr-only dropdownMenu<%- pk %>" type="button" id="dropdownMenu<%- pk %>" data-toggle="dropdown" />
            <ul class="dropdown-menu" role="menu" aria-labelledby="dropdownMenu<%- pk %>">
              <li role="presentation"></li>
              <li role="presentation"><a username="<%- username %>" class="recommend" role="menuitem" tabindex="-1" href="#">Recommend</a></li>
              <li role="presentation"><a username="<%- username %>" class="private_message" role="menuitem" tabindex="-1" href="#">Private message</a></li>
              <li role="presentation"><a username="<%- username %>" class="rate" rateing="user" image_src="<%- avatar %>" score="<%- score %>" ratecount="<%- ratecount %>" role="menuitem" tabindex="-1" href="#">Rate user</a></li>
            </ul>
          </div>
        </div>

      </div>
      <div class="item_container" item_id="<%- username %>">
        <div class="item-title" >
          <a class="linktoprofile" href="<%- profile_url %>"><img src="<%- avatar %>" alt="<%- username %>" /></a>
          <div>&nbsp;</div>
          <div item_id="<%- pk %>"  score="<%- score %>" class="numstars"></div>
          <div class="marketitem_title"><%- tag_line %></div>
        </div>
        <div class="clearfix"></div>
        <div class="item-body"><%- bio %></div>
        <div class="item-title">
          <div>Specialities</div>
        </div>
        <div class="item-tags">
          <div>
            <% _.each(issues, function(ind) { %> <div class="btn btn-default disabled btn-xs"> <%- window.ahr.issues_lookup[ind] %> </div> <% }); %>
            <% _.each(countries, function(ind) { %> <div class="btn btn-default disabled btn-xs"> <%- window.ahr.countries_lookup[ind] %> </div> <% }); %>
            <% _.each(skills, function(ind) { %> <div class="btn btn-default disabled btn-xs"> <%- window.ahr.skills_lookup[ind] %> </div> <% }); %>
          </div>
        </div>
      </div>
    </div>
  </div>
</script>


<script type="text/template" id="user-template-prev">

  <div class="row" item_id="<%- pk %>">
    <div class="col-md-12">
      <div class="well">
        <div class="row">
          <div class="col-md-2">
            <a href="<%- profile_url %>"><img src="<%- avatar%>"/></a>
          </div>
          <div class="col-md-10">
            <div class="row">
              <div><strong>User: </strong><a class="username" href="<%- profile_url %>"><%- username %></a></div>
              <div><strong>Tag: </strong><%- tag_line %></div>
              <div><strong>Bio: </strong><%- bio %></div>
            </div>
          </div>
        </div>
        <div class="row">
          <div class="col-md-12 center-content" style="margin-top:15px;">
            <button type="button" username="<%- username %>" class="recommend btn btn-default btn-sm"> Recommend </button>
            <button type="button" username="<%- username %>" class="btn btn-default btn-sm sendprivatemessageuser"> Private message </button>
            <button type="button" rateing="user" image_src="<%- avatar %>" score="<%- score %>" ratecount="<%- ratecount %>" username="<%- username %>" class="btn btn-default btn-sm rate"> Rate user </button>
          </div>
        </div>
      </div>
    </div>
  </div>

</script>

<script type="text/javascript">
(function(){
    var MarketUserWidget =  window.ahr.BaseView.extend({

      show_dropdown:function(ev){
        ev.preventDefault();
        var item_id = ev.currentTarget.getAttribute('item_id');
        $('.dropdownMenu'+item_id).trigger('click');
        return false;
      },

      private_message: function(ev){
        ev.preventDefault();
        var username = ev.currentTarget.getAttribute('username');
        var item_id = ev.currentTarget.getAttribute('item_id');
        var msgsub = 'Re: '+$('.marketitem_title',$('.market-item-card[item_id='+item_id+']')).text();
        this.message_widget.show(username, msgsub, '', false);
        return(false);
      },

      resetitemrate:function(item_id, rate){
        try{
          $(".numstars[item_id="+item_id+"]").rateit('value',rate);
        }catch(err){
          $.noop();
        }
      },

      recommend: function(ev){
        ev.preventDefault();
        var username = ev.currentTarget.getAttribute('username');
        $('#recsub').val($('#currentusername').text()+' recommends this user : '+ username);
        $('#recsub').attr('readonly',false);
        var href = '<a href="'+window.location.host+window.ahr.app_urls.viewuserprofile+username+'">'+ username +'</a>';
        $('#recmessage').val($('#currentusername').text()+ ' recommend you have a look at user '+ username +' \r\n'+ href );
        $('#touser').val('');
        $('#recommenddialog').modal('show');
        return(false);
      },

      afterset: function(){
        $('.numstars').rateit();
        $('.numstars').rateit('min',0);
        $('.numstars').rateit('max',5);
        $('.numstars').rateit('readonly',true);
        $('.numstars').each(function(){
            $(this).rateit('value',this.getAttribute('score'));
        });
      },

      initialize: function(options){
        this.market = options.market;
        this.item_tmp = _.template($('#user-template').html());
        this.message_widget = window.ahr.messagedialog_widget.initWidget('body', '#infobar');
        this.rate_widget = window.ahr.rate_form_dialog.initWidget('body', this.resetitemrate);

        this.delegateEvents(_.extend(this.events,{
          'click .itemactions' : 'show_dropdown',
          'click .private_message' : 'private_message',
          'click .recommend': 'recommend',
        }));
      }
    });

    window.ahr.marketuser_widget = window.ahr.marketuser_widget || {};
    window.ahr.marketuser_widget.initWidget= function(element,market){
        var marketuser_widget = new MarketUserWidget({el:element, market:market});
        return marketuser_widget;
    };

  })();

</script>